<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recompensas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/admin/css/recompensa.css">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h1 class="h2 fw-bold mb-4">Gerenciar Recompensas</h1>

        <div class="row g-4">
            <!-- Create Form -->
            <div class="col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Criar Nova Recompensa</h5>
                    </div>
                    <div class="card-body">
                        <form id="create-form">
                            <div class="mb-3">
                                <label class="form-label fw-medium">Título *</label>
                                <input type="text" class="form-control" id="titulo" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-medium">Descrição</label>
                                <textarea class="form-control" id="descricao" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label fw-medium">Custo em pontos *</label>
                                    <input type="number" class="form-control" id="custo" min="1" required>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label fw-medium">Quantidade disponível *</label>
                                    <input type="number" class="form-control" id="quantidade" min="1" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-medium">Imagens</label>
                                <input type="file" class="form-control" id="image-files" multiple accept="image/*">
                                <div id="preview" class="mt-3 d-flex flex-wrap gap-2"></div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Criar Recompensa</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div class="col-lg-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recompensas Disponíveis</h5>
                        <button class="btn btn-light btn-sm" id="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="recompensas-lista" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { loadNavbar } from '/admin/components/navbar.js';
        import { uploadImages } from '/jsApiLayer/images.js';
        import { criarRecompensa, listarRecompensas, getRecompensa, resgatarRecompensa } from '/jsApiLayer/recompensa.js';

        //const BASE_URL = window.location.origin;

        loadNavbar();

        document.getElementById('image-files').addEventListener('change', (e) => {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const wrapper = document.createElement('div');
                wrapper.className = 'position-relative';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'border rounded';
                wrapper.appendChild(img);
                preview.appendChild(wrapper);
            });
        });

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = Array.from(document.getElementById('image-files').files);
            try {
                let url_imagens = [];
                if (files.length > 0) {
                    url_imagens = await uploadImages(files);
                }
                await criarRecompensa(
                    document.getElementById('titulo').value.trim(),
                    document.getElementById('descricao').value.trim() || null,
                    parseInt(document.getElementById('custo').value),
                    parseInt(document.getElementById('quantidade').value),
                    url_imagens
                );
                alert('Recompensa criada com sucesso');
                e.target.reset();
                document.getElementById('preview').innerHTML = '';
                loadRecompensas();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        });

        async function loadRecompensas() {
            try {
                const recompensas = await listarRecompensas();
                const container = document.getElementById('recompensas-lista');
                container.innerHTML = '';
                if (recompensas.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-muted">Nenhuma recompensa disponível</div>';
                    return;
                }
                recompensas.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${r.titulo}</h6>
                            <p class="mb-1 small text-muted">${r.descricao ? r.descricao.substring(0, 80) + '...' : 'Sem descrição'}</p>
                            <span class="badge bg-primary">${r.custo_pontos} pts</span>
                            <span class="badge bg-${r.quantidade_disponivel > 0 ? 'success' : 'secondary'}">${r.quantidade_disponivel} disponível</span>
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm resgatar-btn" data-id="${r.id}" ${r.quantidade_disponivel === 0 ? 'disabled' : ''}>Resgatar</button>
                            <button class="btn btn-info btn-sm detail-btn ms-2" data-id="${r.id}">Detalhes</button>
                        </div>
                    `;
                    container.appendChild(item);
                });

                document.querySelectorAll('.resgatar-btn').forEach(btn => {
                    btn.onclick = () => resgatarHandler(btn.dataset.id);
                });
                document.querySelectorAll('.detail-btn').forEach(btn => {
                    btn.onclick = () => showDetail(btn.dataset.id);
                });
            } catch (e) {
                alert('Erro ao carregar recompensas: ' + e.message);
            }
        }

        async function resgatarHandler(id) {
            if (!confirm('Confirmar resgate desta recompensa?')) return;
            try {
                await resgatarRecompensa(id);
                alert('Recompensa resgatada!');
                loadRecompensas();
            } catch (e) {
                alert('Erro: ' + e.message);
            }
        }

        async function showDetail(id) {
            try {
                const r = await getRecompensa(id);
                document.getElementById('modal-title').textContent = r.titulo;
                const body = document.getElementById('modal-body');
                body.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <p><strong>Descrição:</strong> ${r.descricao || 'Sem descrição'}</p>
                            <p><strong>Custo:</strong> ${r.custo_pontos} pontos</p>
                            <p><strong>Disponível:</strong> ${r.quantidade_disponivel}</p>
                        </div>
                        <div class="col-md-4">
                            ${r.url_imagens.length ? r.url_imagens.map(url => `<img src="${url}" class="img-fluid rounded mb-3" alt="Recompensa">`).join('') : '<p class="text-muted">Sem imagens</p>'}
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('detailModal')).show();
            } catch (e) {
                alert('Erro ao carregar detalhes: ' + e.message);
            }
        }

        document.getElementById('refresh-btn').onclick = loadRecompensas;
        loadRecompensas();
    </script>
</body>
</html>